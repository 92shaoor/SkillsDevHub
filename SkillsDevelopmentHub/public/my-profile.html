<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">

  

</head>
<body>
    <header></header>
<div class="container mt-5">
    <h2 class="mb-4 ">My Profile</h2>
    <div id="profileCard" class="card" style="max-width: 900px;">
        <div class="card-body">
            <form id="profileForm">
                <div class="mb-3">
                    <label class="form-label"><strong>Name:</strong></label>
                    <input type="text" class="form-control" id="profileName" name="name" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Email:</strong></label>
                    <input type="email" class="form-control" id="profileEmail" name="email" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Address:</strong></label>
                    <input type="text" class="form-control" id="profileAddress" name="address" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Phone:</strong></label>
                    <input type="text" class="form-control" id="profilePhone" name="phone" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Profession:</strong></label>
                    <input type="text" class="form-control" id="profileProfession" name="profession" disabled>
                </div>
                <button type="button" id="editBtn" class="btn btn-primary">Edit</button>
                <button type="submit" id="saveBtn" class="btn btn-success d-none">Save</button>
                <button type="button" id="cancelBtn" class="btn btn-secondary d-none">Cancel</button>
                <button type="button" id="logoutBtn" class="btn btn-outline-danger float-end">Log out</button>
            </form>
        </div>
    </div>
    <div id="profileError" class="alert alert-danger mt-3 d-none"></div>
    <div id="profileSuccess" class="alert alert-success mt-3 d-none"></div>
</div>
<script>
let userData = {};

async function loadProfile() {
    try {
        const res = await fetch('/my-profile');
        if (!res.ok) throw new Error(await res.text());
        const user = await res.json();
        userData = user;
        document.getElementById('profileName').value = user.firstname + ' ' + user.lastname;
        document.getElementById('profileEmail').value = user.email;
        document.getElementById('profileAddress').value = user.address;
        document.getElementById('profilePhone').value = user.phone;
        document.getElementById('profileProfession').value = user.profession;
    } catch (err) {
        document.getElementById('profileCard').classList.add('d-none');
        const errorDiv = document.getElementById('profileError');
        errorDiv.textContent = err.message || 'Could not load profile.';
        errorDiv.classList.remove('d-none');
    }
}

function setEditable(editable) {
    document.getElementById('profileName').disabled = !editable;
    document.getElementById('profileEmail').disabled = true; // Email should not be editable
    document.getElementById('profileAddress').disabled = !editable;
    document.getElementById('profilePhone').disabled = !editable;
    document.getElementById('profileProfession').disabled = !editable;
    document.getElementById('editBtn').classList.toggle('d-none', editable);
    document.getElementById('saveBtn').classList.toggle('d-none', !editable);
    document.getElementById('cancelBtn').classList.toggle('d-none', !editable);
}

document.getElementById('editBtn').addEventListener('click', function() {
    setEditable(true);
});

document.getElementById('cancelBtn').addEventListener('click', function() {
    // Reset fields to original values
    document.getElementById('profileName').value = userData.firstname + ' ' + userData.lastname;
    document.getElementById('profileAddress').value = userData.address;
    document.getElementById('profilePhone').value = userData.phone;
    document.getElementById('profileProfession').value = userData.profession;
    setEditable(false);
    document.getElementById('profileError').classList.add('d-none');
    document.getElementById('profileSuccess').classList.add('d-none');
});

document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    // Split name into firstname and lastname
    const name = document.getElementById('profileName').value.trim().split(' ');
    const firstname = name[0];
    const lastname = name.slice(1).join(' ') || '';
    const address = document.getElementById('profileAddress').value;
    const phone = document.getElementById('profilePhone').value;
    const profession = document.getElementById('profileProfession').value;

    try {
        const res = await fetch('/my-profile', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ firstname, lastname, address, phone, profession })
        });
        if (!res.ok) throw new Error(await res.text());
        userData.firstname = firstname;
        userData.lastname = lastname;
        userData.address = address;
        userData.phone = phone;
        userData.profession = profession;
        setEditable(false);
        const successDiv = document.getElementById('profileSuccess');
        successDiv.textContent = 'Profile updated successfully!';
        successDiv.classList.remove('d-none');
        document.getElementById('profileError').classList.add('d-none');
    } catch (err) {
        const errorDiv = document.getElementById('profileError');
        errorDiv.textContent = err.message || 'Could not update profile.';
        errorDiv.classList.remove('d-none');
        document.getElementById('profileSuccess').classList.add('d-none');
    }
});

document.getElementById('logoutBtn').addEventListener('click', async function(e) {
    e.preventDefault();
    try {
        const res = await fetch('/logout', {
            method: 'GET',
            credentials: 'include'
        });
        if (res.ok) {
            alert('Logged out successfully!');
            window.location.href = 'login.html';
        } else {
            alert('Logout failed. Please try again.');
        }
    } catch (err) {
        alert('Logout failed. Please try again.');
    }
});

loadProfile();
setEditable(false);
</script>

<footer></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/loadHeaderFooter.js"></script>
</body>
</html>